---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: minio-operator
  namespace: minio-operator
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://oauth2-proxy.github.io/manifests
      chart: minio-operator
      version: 4.2.14
      sourceRef:
        kind: HelmRepository
        name: minio-operator-charts
        namespace: flux-system
      interval: 5m
  values:
    console:
      ingress:
        enabled: true
        labels: {}
        annotations: {}
          #nginx.ingress.kubernetes.io/auth-url: "https://auth.${SECRET_DOMAIN}/oauth2/auth"
          #nginx.ingress.kubernetes.io/auth-signin: https://auth.${SECRET_DOMAIN}/oauth2/start
        tls: 
        - hosts: 
          - minio.${SECRET_DOMAIN}
        host: minio.${SECRET_DOMAIN}
        path: /
    ## MinIO Tenant Definition
    tenants:
      # Tenant name
      - name: minio1
        namespace: minio       
        pools:
          ## Servers specifies the number of MinIO Tenant Pods / Servers in this pool.
          ## For standalone mode, supply 1. For distributed mode, supply 4 or more.
          ## Note that the operator does not support upgrading from standalone to distributed mode.
          - servers: 3
            ## volumesPerServer specifies the number of volumes attached per MinIO Tenant Pod / Server.
            volumesPerServer: 3
            ## size specifies the capacity per volume
            size: 5Gi
            ## storageClass specifies the storage class name to be used for this pool
            storageClassName: longhorn
            ## Used to specify a toleration for a pod
            tolerations: {}
            ## nodeSelector parameters for MinIO Pods. It specifies a map of key-value pairs. For the pod to be
            ## eligible to run on a node, the node must have each of the
            ## indicated key-value pairs as labels.
            ## Read more here: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/
            nodeSelector: {}
            ## Affinity settings for MinIO pods. Read more about affinity
            ## here: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity.
            affinity: {}
            ## Configure resource requests and limits for MinIO containers
            resources: {}
            ## Configure security context
            securityContext: {}
            ## Configure topology constraints
            topologySpreadConstraints: []
        ## Mount path where PV will be mounted inside container(s).
        mountPath: /export
        ## Sub path inside Mount path where MinIO stores data.
        subPath: /data
        # pool secrets
        secrets:
          # create a kubernetes secret object with the accessKey and secretKey as defined here.
          enabled: true
          name: minio1-secret
          accessKey: minio
          secretKey: ${MINIO_TENANT1_SECRETKEY}
        # pool metrics to be read by Prometheus
        metrics:
          enabled: true
          port: 9000    
        certificate:
          ## Use this field to provide one or more external CA certificates. This is used by MinIO
          ## to verify TLS connections with other applications:
          ## https://github.com/minio/minio/tree/master/docs/tls/kubernetes#2-create-kubernetes-secret
          externalCaCertSecret: {}
          ## Use this field to provide a list of Secrets with external certificates. This can be used to to configure
          ## TLS for MinIO Tenant pods. Create secrets as explained here:
          ## https://github.com/minio/minio/tree/master/docs/tls/kubernetes#2-create-kubernetes-secret
          externalCertSecret: {}
          ## Enable automatic Kubernetes based certificate generation and signing as explained in
          ## https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster
          requestAutoCert: true
          ## This field is used only when "requestAutoCert" is set to true. Use this field to set CommonName
          ## for the auto-generated certificate. Internal DNS name for the pod will be used if CommonName is
          ## not provided. DNS name format is *.minio.default.svc.cluster.local
          certConfig: 
            - *.minio.svc.cluster.local   
        