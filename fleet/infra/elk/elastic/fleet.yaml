defaultNamespace: elastic
helm:
  releaseName: elasticsearch
  chart: elasticsearch
  repo: https://helm.elastic.co
  version: 7.15.0
  values:
    esConfig: 
      elasticsearch.yml: |
        xpack.security.enabled: true
        xpack.security.transport.ssl.enabled: true        
        xpack.security.transport.ssl.verification_mode: certificate
        # keystore.p12 will be generated by the pod it-self, at init phase
        xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs-gen/keystore.p12
        xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs-gen/keystore.p12
    resources:
      requests:
        cpu: "500m"
        memory: "2Gi"
      limits:
        cpu: "1000m"
        memory: "2Gi"
    volumeClaimTemplate:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 15Gi
      storageClassName: longhorn-nobackup

    # cert-stuff (https://thomasdecaux.medium.com/configure-transport-layer-security-tls-ssl-for-an-elasticsearch-cluster-deployed-with-helm-on-fbbac2325a00)  
    extraVolumes:
    - name: tls-certificates
      emptyDir: {}
    
    extraVolumeMounts:
    - name: tls-certificates
      mountPath: /usr/share/elasticsearch/config/certs-gen

    extraInitContainers:
    - name: setup-tls-cert
      image: "docker.elastic.co/elasticsearch/elasticsearch:7.15.0"
      command:
      - sh
      - -c
      - |
        #!/usr/bin/env bash
        set -euo pipefail
        elasticsearch-certutil cert \
          --name ${NODE_NAME} \
          --days 1000 \
          --ip ${POD_IP} \
          --dns ${NODE_NAME},${POD_SERVICE_NAME},${POD_SERVICE_NAME_HEADLESS},${NODE_NAME}.${POD_SERVICE_NAME},${NODE_NAME}.${POD_SERVICE_NAME_HEADLESS} \
          --ca-cert /usr/share/elasticsearch/config/certs/tls.crt \
          --ca-key /usr/share/elasticsearch/config/certs/tls.key  \
          --ca-pass "" \
          --pass "" \
          --out /usr/share/elasticsearch/config/certs-gen/keystore.p12
      env:
      - name: NODE_NAME
        valueFrom:
          fieldRef:
            fieldPath: metadata.name
      - name: POD_IP
        valueFrom:
          fieldRef:
            fieldPath: status.podIP
      - name: POD_SERVICE_NAME
        value: "elasticsearch-master"
      - name: POD_SERVICE_NAME_HEADLESS
        value: "elasticsearch-master-headless"
      volumeMounts:
      - name: elastic-certificates
        mountPath: /usr/share/elasticsearch/config/certs
      - name: tls-certificates
        mountPath: /usr/share/elasticsearch/config/certs-gen

    # mount the CA from secret
    secretMounts:
    - name: elastic-certificates
      secretName: elastic-cert
      path: /usr/share/elasticsearch/config/certs

dependsOn:
  - name: longhorn-fleet-infra-longhorn-longhorn-deployment