---
# tasks file for ronnywalter.common
- name: change hostname
  hostname:
    name: "{{ansible_host.split('.')[0]}}"

- name: Upgrade all packages to the latest version
  apt:
    name: "*"
    state: latest

- name: Configuring /etc/modules for rancher (https://rancher.com/docs/rke/latest/en/os/)
  template:
    src: modules.conf.j2
    dest: /etc/modules-load.d/rancher
    owner: root
    group: root
    mode: '644'

- name: Reboot box if kernel/libs updated and requested by the system
  shell: sleep 2 && /sbin/shutdown -r now 'Rebooting box to update system libs/kernel as needed' 
  args:
      removes: /var/run/reboot-required
  async: 300
  poll: 0
  ignore_errors: true

- name: Wait for system to become reachable again
  wait_for_connection:
      delay: 5
      timeout: 300

- name: ensure a list of packages installed
  apt:
    name: "{{ packages }}"
  vars:
    packages:
    - open-iscsi
    - nfs-common

- name: Enable service rpcbind, and not touch the state
  service:
    name: rpcbind
    enabled: yes

- name: Start service rpcbind
  service:
    name: rpcbind
    state: restarted 

#- name: Configuring /etc/hosts (hostnames with private adresses)
#  template:
#    src: hosts.j2
#    dest: /etc/hosts
#    owner: root
#    group: root
#    mode: '644'

#- name: disable automatic resolv.conf
#  lineinfile:
#    dest: /etc/sysconfig/network-scripts/ifcfg-eth0
#    regexp: "^PEERDNS"
#    line: "PEERDNS=no"
#    state: present
